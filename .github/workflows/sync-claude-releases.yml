name: Sync Claude Code Releases

on:
  schedule:
    # 每天UTC 00:00 运行
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要创建 Release 的权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true

      - name: Create virtual environment
        run: uv venv --python 3.12

      - name: Install dependencies
        run: uv pip install -r requirements.txt

      - name: Download Claude Code releases
        id: download
        run: .venv/bin/python scripts/download_claude.py
        env:
          GCS_BUCKET: https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases

      - name: Get version info
        id: version
        run: |
          VERSION=$(cat .version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if gh release view "$VERSION" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $VERSION does not exist"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(cat .build_date)

          # 创建 Release
          gh release create "$VERSION" \
            --title "Claude Code v$VERSION" \
            --notes "## Claude Code v$VERSION

          **构建日期**: $BUILD_DATE

          ### 下载平台

          | 平台 | 文件 |
          |------|------|
          | macOS Apple Silicon | \`claude-darwin-arm64\` |
          | macOS Intel | \`claude-darwin-x64\` |
          | Linux x64 (glibc) | \`claude-linux-x64\` |
          | Linux x64 (musl) | \`claude-linux-x64-musl\` |
          | Linux arm64 (glibc) | \`claude-linux-arm64\` |
          | Linux arm64 (musl) | \`claude-linux-arm64-musl\` |
          | Windows x64 | \`claude-win32-x64.exe\` |

          ### SHA256 Checksums

          \`\`\`
          $(cat .checksums)
          \`\`\`

          ---
          *此版本自动从官方 GCS 存储桶同步*
          "

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          UPLOAD_DIR="releases/$VERSION"

          # 上传所有平台文件
          for file in "$UPLOAD_DIR"/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              gh release upload "$VERSION" "$file" --clobber
            fi
          done

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          # 清理临时文件
          rm -f .version .build_date .checksums
          rm -rf releases/